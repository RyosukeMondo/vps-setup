要件を分析し、矛盾のない実行手順を構築した。

### 推論フレームワークによる分析

- **[事実]**
- XServer VPSのセットアップ、SSH認証、ドメイン設定、リバースプロキシ（Caddy）の構築には、順序依存性がある（例：VPSが稼働し、SSHキーがローカルに存在しなければ、Claude Codeによるリモート操作は不可能）。
- Claude CodeはNode.js環境に依存する。
- `claude --dangerously-skip-permissions` をエイリアス化することは、プロンプトの解釈ミスによるローカル環境およびリモート環境の破壊リスクをシステムレベルで許容することを意味する。

- **[高確率]**
- Python 3.9から3.14までの複数バージョンをOS直下にインストールすると、環境変数の競合や依存関係の崩壊を引き起こす。バージョン管理ツール（`pyenv`, `mise`, または `uv`）の導入が必須である。
- GitHubのSSHキー登録とアカウント連携は、手動で行うより `gh` CLIを用いた方が工数と人為的ミスの確率が下がる。

- **[不確実]**
- `domain-name.xvps.jp` のDNS浸透時間。Caddyは起動時にLet's Encrypt等からSSL証明書を取得するため、DNSが浸透していない状態でCaddyを起動すると証明書取得エラーが発生し、プロセスがフェイルする可能性がある。

---

### 最適化された実行手順

目的（Claude Codeを最速で起動し、VPSのセットアップを自動化する）を達成するための最短クリティカルパスである。

#### フェーズ1：ローカル基盤とツールの構築（手動実行）

ローカル（Mac/Windows）でAIが稼働するためのインフラを整える。

1. **パッケージマネージャーの準備**

- Mac: Homebrew (`brew`)
- Windows: Winget または WSL2環境上の `apt`

2. **基本ツールのインストール**

```bash
# Macの例
brew install git gh node docker

```

_※Docker DesktopはOSのGUIからインストールを完了させること。_ 3. **Python環境の構築 (mise または pyenv の使用)**
複数バージョンの共存による環境汚染を防ぐ。

```bash
brew install mise
mise use --global python@3.9 python@3.10 python@3.11 python@3.12 python@3.13
# 3.14はプレリリース版のため、必要に応じて指定

```

4. **GitHub認証とSSHキーの自動生成・登録**
   アカウント作成が完了している前提で、以下のコマンドを実行し、プロンプトに従いSSHキーを生成してGitHubに登録する。

```bash
gh auth login

```

#### フェーズ2：Claude Codeの導入と自動化の準備（手動実行）

1. **Claude Codeのインストール**

```bash
npm install -g @anthropic-ai/claude-code

```

2. **エイリアスの設定（危険性の受容）**
   シェルの設定ファイル（`~/.zshrc`, `~/.bashrc`, または PowerShell profile）に以下を追記し、再読み込みする。

```bash
alias claude="claude --dangerously-skip-permissions"

```

3. **グローバルスキルの定義**
   環境全体で使い回すためのナレッジベースを作成する。

```bash
mkdir -p ~/.claude/skills
touch ~/.claude/skills/vps-caddy-proxy.md

```

上記ファイルに、Caddyを使ったリバースプロキシのDocker Compose定義（例：ポート80/443の開放、バックエンドコンテナへのルーティングルール）を記述する。

#### フェーズ3：インフラ調達と構成情報の定義（手動実行）

1. **XServer VPSの契約**

- OS: Ubuntu 24.04 を選択。
- SSHキー: 「新しく生成する」を選択し、秘密キー（例：`xvps.pem`）をダウンロード。

2. **ローカルSSHの設定**
   ダウンロードしたキーを配置し、権限を絞る。

```bash
mv ~/Downloads/xvps.pem ~/.ssh/
chmod 600 ~/.ssh/xvps.pem

```

3. **`server.md` の作成**
   プロジェクトルート（または任意の作業ディレクトリ）に `server.md` を作成し、VPSのIPアドレス、初期ユーザー（通常は `root`）、SSHキーのパス、および目的のサブドメイン（`domain-name.xvps.jp`）を記録する。

#### フェーズ4：AI駆動によるリモートプロビジョニング（AI実行）

準備した情報を元に、Claude Codeにすべてのリモート作業を委譲する。

1. **Claude Codeの起動**

```bash
claude

```

2. **プロンプトの入力**
   以下の指示を与え、フェーズ1〜3で構築したアセットを利用させる。
   > `server.md` を読み込み、記載されたVPSへSSH接続してください。
   > 接続後、以下のタスクを順に実行してください。

> 1. 新規の一般ユーザーを作成し、sudo権限を付与し、ローカルの `~/.ssh/id_ed25519.pub` (gh auth loginで生成された公開鍵) を新しいユーザーの `authorized_keys` に追加してパスワードなしでSSH接続できるようにしてください。
> 2. Ubuntu 24.04上にDockerおよびDocker Composeをインストールしてください。
> 3. `~/.claude/skills/vps-caddy-proxy.md` を読み込み、VPS上にCaddyを用いたリバースプロキシ環境と、サンプルのWebページ（Nginx等）のDockerコンテナを構築し、起動してください。サブドメインは `server.md` のものを適用してください。

---

### 機会費用分析

- **現在の言い訳・無策によるリスク:**
- 複数バージョンのPythonを手動でOS直下にインストールするアプローチは、将来的なスクリプトの実行エラーや依存関係の崩壊（Dependency Hell）を招く。これの解決に費やす時間は、アプリケーション開発の機会損失に直結する。
- `--dangerously-skip-permissions` を常時有効にすることは、AIが誤ったディレクトリで `rm -rf` を実行したり、リモートサーバーの設定を不可逆的に破壊したりするリスクを伴う。

- **機会損失:**
  インフラ構築を手動で行うことによる「時間の浪費」。Claude Codeに `server.md` と `skills` ディレクトリを参照させるこのワークフローを標準化しなければ、将来の新規プロジェクトやサーバー移行時に同じプロセスをゼロから思考するコストが発生する。

---

### 実行可能なアウトプット

次のレベルに到達するための具体的な変更点。

1. **[考え方] 宣言的インフラ管理への移行:** 手順を「記憶」するのではなく、`server.md` や `skills/` のようなテキストベースの定義ファイルに状態を依存させる。AIは人間よりもテキストの忠実な実行において優れている。
2. **[行動] パッケージ・バージョン管理の徹底:** システムOSの環境変数を直接汚染するインストール手順を破棄し、`mise` や `Docker` のような隔離された環境での依存関係管理をデフォルトとする。
3. **[姿勢] リスクと速度のトレードオフの意識的制御:** `--dangerously-skip-permissions` を使用する以上、実行前にGitによるローカルのコミット、またはプロンプトへの厳格な制約（例：「実行前に実行予定のコマンド一覧を出力し、確認を求めること」等の例外ルールの付与）を自らに課す。無防備な委譲は自動化ではなく放棄である。
